<!DOCTYPE html>
<html lang="en">

<head>
    {% include 'common/head.html' %}
    <title>Game Analysis Dashboard – Minigames</title>
    <script defer src="{{ url_for('static', filename='js/minigames_analysis.js') }}"></script>

    <!-- Ion.RangeSlider CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ion-rangeslider/css/ion.rangeSlider.min.css" />

    <!-- jQuery (required for Ion.RangeSlider) -->
    <script defer src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Ion.RangeSlider JS -->
    <script defer src="https://cdn.jsdelivr.net/npm/ion-rangeslider/js/ion.rangeSlider.min.js"></script>

    <!-- --- Tiny page-specific styles --- -->
    <style>
        /* simple responsive grid */
        #gamesGrid {
            --gap: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: var(--gap);
            margin: 1.5rem auto;
            max-width: 1200px;
            padding: 0 var(--gap);
        }

        .game-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .08);
            padding: 1rem 1.25rem;
            transition: transform .15s ease, box-shadow .15s ease;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }

        .game-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, .12);
        }

        .game-card h2 {
            font-size: 1.05rem;
            margin: 0 0 .25rem;
            font-weight: 600
        }

        .game-card p {
            font-size: .9rem;
            margin: 0;
            color: #555
        }

        body {
            background-color: #ffffff !important;
        }

        #aiModalBody h1,
        #aiModalBody h2,
        #aiModalBody h3 {
            font-weight: bold;
            font-size: 1.4rem;   /* adjust as needed */
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #222;         /* darker for emphasis */
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <!-- Sidebar -->
        {% include 'common/sidebar.html' %}
        <!-- Main Content -->
        <div class="main">
            {% include 'common/header.html' %}
            
            <div class="container my-3 d-flex justify-content-between align-items-start">

                <input type="search" id="gameSearchInput" class="form-control w-50 me-3" placeholder="Search minigames by name...">

                <select id="sortSelect" class="form-select w-auto">
                    <option value="">Sort By</option>
                    <option value="name_asc">Name (A–Z)</option>
                    <option value="name_desc">Name (Z–A)</option>
                    <option value="score_desc">Average Score (High → Low)</option>
                    <option value="score_asc">Average Score (Low → High)</option>
                </select>

                <button class="btn btn-primary dropdown-toggle" id="filterButton" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-funnel-fill" veriewBox="0 0 16 16">
                        <path
                            d="M1.5 1.5a.5.5 0 0 1 .5-.5h12a.5.5 0 0 1 .4.8L10 8.293V14.5a.5.5 0 0 1-.8.4l-2-1.5a.5.5 0 0 1-.2-.4V8.293L1.1 1.8a.5.5 0 0 1 .4-.8z" />
                    </svg>
                    Filter
                </button>

                <div class="dropdown-menu p-3" style="min-width: 320px;">
                    <form id="filterForm">
                        <label class="form-label mb-3">Filter by (Multi-Select):</label>

                        <!-- Total Attempts -->
                        <div class="mb-3">
                            <div class="form-check mb-1">
                                <input class="form-check-input" type="checkbox" name="filterTypes"
                                    value="total_attempts" id="filterAttempts">
                                <label class="form-check-label" for="filterAttempts">Total Attempts</label>
                            </div>
                            <input type="text" id="range_total_attempts" name="range_total_attempts" disabled>
                            <div class="d-flex justify-content-between mt-1">
                                <input type="number" id="input_min_total_attempts"
                                    class="form-control form-control-sm w-45" placeholder="Min" disabled>
                                <input type="number" id="input_max_total_attempts"
                                    class="form-control form-control-sm w-45" placeholder="Max" disabled>
                            </div>
                        </div>

                        <!-- Completion Rate -->
                        <div class="mb-3">
                            <div class="form-check mb-1">
                                <input class="form-check-input" type="checkbox" name="filterTypes"
                                    value="completion_rate" id="filterCompletion">
                                <label class="form-check-label" for="filterCompletion">Completion Rate</label>
                            </div>
                            <input type="text" id="range_completion_rate" name="range_completion_rate" disabled>
                            <div class="d-flex justify-content-between mt-1">
                                <input type="number" id="input_min_completion_rate"
                                    class="form-control form-control-sm w-45" placeholder="Min" disabled>
                                <input type="number" id="input_max_completion_rate"
                                    class="form-control form-control-sm w-45" placeholder="Max" disabled>
                            </div>
                        </div>

                        <!-- Average Score -->
                        <div class="mb-3">
                            <div class="form-check mb-1">
                                <input class="form-check-input" type="checkbox" name="filterTypes" value="average_score"
                                    id="filterAvgScore">
                                <label class="form-check-label" for="filterAvgScore">Average Score</label>
                            </div>
                            <input type="text" id="range_average_score" name="range_average_score" disabled>
                            <div class="d-flex justify-content-between mt-1">
                                <input type="number" id="input_min_average_score"
                                    class="form-control form-control-sm w-45" placeholder="Min" disabled>
                                <input type="number" id="input_max_average_score"
                                    class="form-control form-control-sm w-45" placeholder="Max" disabled>
                            </div>
                        </div>

                        <!-- Failed -->
                        <div class="mb-3">
                            <div class="form-check mb-1">
                                <input class="form-check-input" type="checkbox" name="filterTypes" value="failed"
                                    id="filterFailed">
                                <label class="form-check-label" for="filterFailed">Failed</label>
                            </div>
                            <input type="text" id="range_failed" name="range_failed" disabled>
                            <div class="d-flex justify-content-between mt-1">
                                <input type="number" id="input_min_failed" class="form-control form-control-sm w-45"
                                    placeholder="Min" disabled>
                                <input type="number" id="input_max_failed" class="form-control form-control-sm w-45"
                                    placeholder="Max" disabled>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-sm btn-primary w-100 mt-2">Apply</button>
                    </form>
                </div>

            </div>

            <!-- grid is filled by JS -->
            <section id="gamesGrid" class="grid gap-4   /* space between cards           */
                sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4  /* 2-4 cols */
                auto-rows-auto"></section>

            <!-- Combined Minigame Stats -->
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                <h5 class="card-title mb-0 text-dark">Minigame Stats</h5>
                <div class="text-muted small">Failure/Success ratio and Avg Attempts Before First Success</div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <select id="combinedModeSelect" class="form-select form-select-sm">
                    <option value="all">All</option>
                    <option value="practice">Practice</option>
                    <option value="training">Training</option>
                    </select>
                    <button id="refreshCombinedBtn" class="btn btn-sm btn-outline-primary">Refresh</button>
                </div>
                <button id="refreshCombinedBtn" class="btn btn-sm btn-outline-primary">Refresh</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                <table id="combinedTable" class="table table-sm table-striped align-middle">
                    <thead>
                    <tr>
                        <th style="min-width: 240px;">Game</th>
                        <th>Mode</th> <!-- NEW -->
                        <th class="text-end">Completed</th>
                        <th class="text-end">Failed</th>
                        <th class="text-end">Userexit</th>
                        <th class="text-end">Failure:Success</th>
                        <th class="text-end">Ratio (Failed/Success)</th>
                        <th class="text-end">Avg Attempts Before Success</th>
                        <th class="text-end">Users Considered</th>
                        <th class="text-end">Action</th>
                    </tr>
                    </thead>
                    <tbody><!-- filled by JS --></tbody>
                </table>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal for Game Stats -->
    <div class="modal fade" id="statsModal" tabindex="-1" aria-labelledby="statsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statsModalLabel">Game Stats</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="statsModalBody">
                    <p>Loading game statistics...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Summary Modal -->
    <div class="modal fade" id="aiModal" tabindex="-1" aria-labelledby="aiModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiModalLabel">AI-Generated Summary</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="aiModalBody">
                    <p>Loading...</p>
                </div>
                <div class="modal-footer">
                    <button class="button d-none" type="button" id="btn-download-analysis">
                        <span class="button__text">Download</span>
                        <span class="button__icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 35 35"
                                id="bdd05811-e15d-428c-bb53-8661459f9307" data-name="Layer 2" class="svg">
                                <path
                                    d="M17.5,22.131a1.249,1.249,0,0,1-1.25-1.25V2.187a1.25,1.25,0,0,1,2.5,0V20.881A1.25,1.25,0,0,1,17.5,22.131Z">
                                </path>
                                <path
                                    d="M17.5,22.693a3.189,3.189,0,0,1-2.262-.936L8.487,15.006a1.249,1.249,0,0,1,1.767-1.767l6.751,6.751a.7.7,0,0,0,.99,0l6.751-6.751a1.25,1.25,0,0,1,1.768,1.767l-6.752,6.751A3.191,3.191,0,0,1,17.5,22.693Z">
                                </path>
                                <path
                                    d="M31.436,34.063H3.564A3.318,3.318,0,0,1,.25,30.749V22.011a1.25,1.25,0,0,1,2.5,0v8.738a.815.815,0,0,0,.814.814H31.436a.815.815,0,0,0,.814-.814V22.011a1.25,1.25,0,1,1,2.5,0v8.738A3.318,3.318,0,0,1,31.436,34.063Z">
                                </path>
                            </svg></span>
                    </button>
                    <button class="button d-none" type="button" id="btn-cancel-analysis" data-bs-dismiss="modal">
                        <span class="button__text">Cancel</span>
                        <span class="button__icon"><svg class="svg" height="512" viewBox="0 0 512 512" width="512"
                                xmlns="http://www.w3.org/2000/svg">
                                <line x1="112" y1="112" x2="400" y2="400"
                                    style="stroke:#fff;stroke-linecap:round;stroke-width:32px" />
                                <line x1="400" y1="112" x2="112" y2="400"
                                    style="stroke:#fff;stroke-linecap:round;stroke-width:32px" />
                            </svg></span>
                    </button>
                    <!-- Regenerate analysis button -->
                    <button class="button d-none" type="button" id="btn-regenerate-analysis">
                        <span class="button__text">Regenerate</span>
                        <span class="button__icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38" />
                            </svg></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Helper function to show stats modal -->
    <script>
        let statsModalInstance = null;

        function showStatsModal(htmlContent) {
            const modalBody = document.getElementById('statsModalBody');
            modalBody.innerHTML = htmlContent;

            if (!statsModalInstance) {
                statsModalInstance = new bootstrap.Modal(document.getElementById('statsModal'), {
                    backdrop: true
                });
            }

            statsModalInstance.show();
        }

        let aiModalInstance = null;

        function showAiModal(htmlContent) {
            const body = document.getElementById('aiModalBody');
            body.innerHTML = htmlContent;

            if (!aiModalInstance) {
                aiModalInstance = new bootstrap.Modal(document.getElementById('aiModal'), {
                    backdrop: true
                });
            }

            aiModalInstance.show();
        }

        document.getElementById('statsModal').addEventListener('hidden.bs.modal', () => {
            statsModalInstance = null;

            // Force-remove any remaining modal backdrop and cleanup
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
        });

        document.getElementById('aiModal').addEventListener('hidden.bs.modal', () => {
            aiModalInstance = null;

            // Force-remove any remaining modal backdrop and cleanup
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
        });

        
    </script>
</body>

</html>